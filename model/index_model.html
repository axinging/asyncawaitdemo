<!-- Copyright 2019 Google LLC. All Rights Reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
==============================================================================-->

<html>

<head>
  <title>TensorFlow.js Op demo</title>
</head>

<body>
  <h2>TensorFlowJS model demo</h2>
  <div> Parameter: index_model.html?backend=webgpu&localBuild=webgl,webgpu,core </div>
  <script src="loader.js"></script>
  <script src="model.js"></script>
  <script src="model2.js"></script>
  <script src="tensor.js"></script>
  <script src="finalization_registry.js"></script>
  <script>
    'use strict';
    async function loadWeightsFile(file) { // Promise<ArrayBuffer> 
      return new Promise((resolve, reject) => {
        const weightFileReader = new FileReader();
        weightFileReader.onload = (event) => {
          // tslint:disable-next-line:no-any
          const weightData = (event.target).result;//  as ArrayBuffer;
          var array = new Int32Array(weightData);
          console.log(JSON.stringify(array));
          resolve(weightData);
        };
        weightFileReader.onerror = error =>
          reject(`Failed to weights data from file of path '${file}'.`);
        weightFileReader.readAsArrayBuffer(file);
      });
    }

    async function httpTest() {
      // Calling io.http() method
      const result = tf.io.http('demo.json');

      // Printing output
      const tmp = await result.load();
      const buffer = tmp.weightData;
      let view = new Int32Array(buffer);
      console.log(JSON.stringify(view));
    }


    async function gpumemoryTest() {

      {
        console.log("Case tidy");
        const start = tf.memory().numTensors;
        tf.tidy(() => {
          const a = tf.scalar(1);
          tf.square(a);  // Uploads to GPU.
          //const b = tf.scalar(1);
          //tf.square(b);  // Uploads to GPU.
        });
        const end = tf.memory().numTensors;
        console.log("start = " + start + ", end = " + end + ", leak = " + (end - start));
      }

    }

    function memoryTest() {
      bar = "this is a hidden global variable";
    }

    function memoryTimerTest() {
      var someResource = 100;// getData();
      setInterval(function () {
        var node = document.getElementById('Node');
        if (node) {
          // Do stuff with node and someResource.
          node.innerHTML = JSON.stringify(someResource);
        }
        console.log("called");
      }, 1000);
    }

    (async function () {
      // let localBuild = ['core', 'webgl', 'webgpu', 'tfjs-converter'];
      let localBuild = [];
      await loadTFJS(localBuild);
      await tf.setBackend('webgpu');
      await tf.ready();
      tf.env().set('WEBGPU_CPU_FORWARD', false);

      //await runTFJSModel();
      //await runTFJSModel2();
      // await gpumemoryTest();
      //

      // await httpTest();
      // await weightFileTest();

      //await tensorTest();
      finalization_registry();
      // memoryTest();
      // memoryTimerTest();
    })();
  </script>
</body>

</html>